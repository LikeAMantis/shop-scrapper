<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Product List</title>
        <link rel="stylesheet" href="styles.css">
    </head>

    <body class="colCenter">
        <h1>Product List</h1>
        <div class="shops colCenter">
            <div class="search"><input id="searchInput" type="text"><button id="findBtn">Find</button></div>
        </div>
        <div class="container rowCenter"></div>
        <footer></footer>
    </body>

    <script type="module">
        var container = document.querySelector(".container");
        const offset = 100;
        var from = 0;
        var to = from + offset;
        var isFetch = true;
        var items;
        var categorie = "spar/obst-gemuese";
        
        await createShopCategories();
        var activeCategorie = document.querySelector(".categories button");
        activeCategorie.setAttribute("active", true);


        // Event Listeners
        let options = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1,
        }
        const observer = new IntersectionObserver(async () => {
            console.log("end");
            if (!isFetch) return;

            items = await getData();
            drawItems(items);

            from += offset;
            to += offset;
        }, options);
        observer.observe(document.querySelector("footer"));

        document.querySelector("#findBtn").onclick = async () => {
            var input = document.querySelector("#searchInput");

            container.innerHTML = "";

            if (input.value == "") {
                isFetch = true;
                drawItems(items);
            } else {
                isFetch = false;
                drawItems(await getFilteredData(input.value));
            }
        };


        document.querySelectorAll(".categories").forEach(x => x.addEventListener("click", (e) => {
            let target = e.target;

            if (target.nodeName !== "BUTTON") return;
            activeCategorie.toggleAttribute("active");
            target.toggleAttribute("active");
            activeCategorie = target;

            isFetch = true;
            container.innerHTML = "";

            categorie = target.parentElement.dataset.categorie + "/" + target.innerText.toLowerCase();
            resetOffset();

            getData();
        }));



        // Funtions
        async function createShopCategories() {
            const container = document.querySelector(".shops");
            const shops = await fetch(`http://localhost:3000/shops`).then(res => res.json());
            
            for (var shop of shops) {
                var shopDiv = document.createElement("div");
                shopDiv.className = "categories rowCenter";
                shopDiv.setAttribute("data-categorie", shop.name);
                shopDiv.innerHTML = `<h3>${shop.name[0].toUpperCase() + shop.name.substr(1)}</h3>`

                for (var categorie of shop.categories) {
                    shopDiv.innerHTML += `<button>${categorie[0].toUpperCase() + categorie.substr(1)}</button>`
                }
                container.insertBefore(shopDiv, container.children[0]);
            }
        }

        function drawItems(items) {
            for (var item of items) {
                let div = document.createElement("div");
                div.className = "item";
                div.innerHTML = `
                    <h3 class="title">${item.name}</h3>
                    <img class="productImg" src=${item.imgUrl}
                        alt="">
                    <div class="price">${item.price}â‚¬</div>
                `;
                container.append(div);
            }
        }

        async function getData() {
            const res = await fetch(`http://localhost:3000/items?categorie=${categorie}&from=${from}&to=${to}`);
            const data = await res.json();
            return data;
        }

        async function getFilteredData(text) {
            const res = await fetch(`http://localhost:3000/filter?categorie=${categorie}&text=${text}`);
            const data = await res.json();
            return data;
        }

        function resetOffset() {
            from = 0;
            to = from + offset;
        }

    </script>

</html>